# ArgoCD Helm Chart Values with GlueOps Extension
# Usage: 
#   1. Download extension: curl -L -o extension.tar.gz https://github.com/venkatamutyala/argocd-glueops-extension/releases/download/v1.0.0/extension.tar.gz
#   2. Create ConfigMap: kubectl create configmap extension-tar --from-file=extension.tar.gz=extension.tar.gz -n argocd
#   3. Install ArgoCD: helm install argocd argo/argo-cd -f helm-values.yaml -n argocd --create-namespace

# Enable proxy extension
server:
  extraArgs:
    - --server.enable.proxy.extension=true
  config:
    # Configure proxy extension backend (hardcoded Postman Echo URL)
    extension.config: |
      extensions:
      - name: app-links-extension
        backend:
          services:
          - url: https://postman-echo.com
  # Add extension installer init container
  initContainers:
    - name: argocd-extension-installer
      image: quay.io/argoprojlabs/argocd-extension-installer:v0.0.5@sha256:27e72f047298188e2de1a73a1901013c274c4760c92f82e6e46cd5fbd0957c6b
      env:
        - name: EXTENSION_NAME
          value: app-links-extension
        - name: EXTENSION_URL
          value: file:///extension/extension.tar.gz
        - name: EXTENSION_VERSION
          value: "1.0.0"
        - name: EXTENSION_ENABLED
          value: "true"
      volumeMounts:
        - name: extensions
          mountPath: /tmp/extensions/
        - name: extension-tar
          mountPath: /extension
          readOnly: true
      securityContext:
        runAsUser: 1000
        allowPrivilegeEscalation: false
  # Add volumes for extension
  volumes:
    - name: extensions
      emptyDir: {}
    - name: extension-tar
      configMap:
        name: extension-tar
  # Mount extension volume in server container
  volumeMounts:
    - name: extensions
      mountPath: /tmp/extensions/

# Configure RBAC for extensions
configs:
  rbac:
    policy.csv: |
      p, role:org-admin, extensions, invoke, app-links-extension, allow
      p, role:admin, extensions, invoke, app-links-extension, allow
      p, role:readonly, extensions, invoke, app-links-extension, allow
      g, admin, role:admin
      g, argocd, role:org-admin

